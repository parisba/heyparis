<!DOCTYPE html>
<html lang="{{ .Site.Language.Lang | default "en" }}">
<head>
  {{ partial "head.html" . }}
</head>
{{ $seg := index (split .RelPermalink "/") 1 }}<body class="{{ with $seg }}section-{{ . }}{{ end }}">
  <div class="accent-bar"></div>

  <header class="site-header">
    <div class="container">
      <div class="site-title-group">
        <a href="{{ "/" | relURL }}" class="site-title">{{ .Site.Title }}</a>
        <span class="site-tagline">Technology · Policy · Games · Arts · Education · Writing</span>
      </div>
      <nav class="site-nav">
        {{ range .Site.Menus.main }}
        <a href="{{ .URL }}"{{ if $.IsMenuCurrent "main" . }} class="active"{{ end }}>{{ .Name }}</a>
        {{ end }}
      </nav>
    </div>
  </header>

  <main class="site-main">
    {{ block "main" . }}{{ end }}
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>{{ with .Site.Params.copyright }}{{ . | markdownify }}{{ else }}&copy; {{ now.Year }} {{ .Site.Title }}{{ end }} · <a href="/privacy/">Privacy</a></p>
    </div>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    // Track outbound link clicks (with page context to distinguish post vs non-post)
    document.addEventListener('click', function (e) {
      var link = e.target.closest('a[href]');
      if (!link) return;
      var href = link.getAttribute('href');
      if (href && href.startsWith('http') && !href.includes(location.hostname)) {
        var path = location.pathname;
        var section = path.startsWith('/posts/') ? 'post' : path.replace(/^\/|\/$/g, '').split('/')[0] || 'home';
        umami.track('outbound-click', { url: href, page: path, section: section });
      }
    });

    // Track nav menu clicks
    document.querySelectorAll('.site-nav a').forEach(function (a) {
      a.addEventListener('click', function () {
        umami.track('nav-click', { page: a.textContent.trim() });
      });
    });

    // Track section jump link clicks (on /about/)
    document.querySelectorAll('a[href^="#"]').forEach(function (a) {
      a.addEventListener('click', function () {
        umami.track('section-jump', { target: a.getAttribute('href') });
      });
    });

    // Track scroll depth (25%, 50%, 75%, 100%)
    var depths = [25, 50, 75, 100];
    var fired = {};
    window.addEventListener('scroll', function () {
      var scrollPct = Math.round(100 * (window.scrollY + window.innerHeight) / document.documentElement.scrollHeight);
      depths.forEach(function (d) {
        if (scrollPct >= d && !fired[d]) {
          fired[d] = true;
          umami.track('scroll-depth', { depth: d });
        }
      });
    }, { passive: true });

    // Book fling effect — covers burst out of publisher cards then fade away
    document.querySelectorAll('.entity-card--with-books').forEach(function (card) {
      var strip = card.querySelector('.books-hover-strip');
      if (!strip) return;

      var srcs = Array.from(strip.querySelectorAll('img')).map(function (img) {
        return { src: img.src, alt: img.alt };
      });
      var flung = [];
      var timeout_ids = [];

      // pre-create elements
      srcs.forEach(function (s) {
        var el = document.createElement('img');
        el.src = s.src;
        el.alt = s.alt;
        el.className = 'book-flung';
        card.appendChild(el);
        flung.push(el);
      });

      card.addEventListener('mouseenter', function () {
        // clear any pending fade-outs
        timeout_ids.forEach(clearTimeout);
        timeout_ids = [];

        var n = flung.length;
        flung.forEach(function (el, i) {
          // distribute evenly in a ring, starting from top
          var baseAngle = (i / n) * Math.PI * 2 - Math.PI / 2;
          var angle = baseAngle + (Math.random() - 0.5) * 0.5;
          var dist = 160 + Math.random() * 120;
          var x = Math.cos(angle) * dist;
          var y = Math.sin(angle) * dist;
          var rot = (Math.random() - 0.5) * 60;
          var scale = 0.85 + Math.random() * 0.3;

          // reset to center instantly
          el.style.transition = 'none';
          el.style.opacity = '1';
          el.style.transform = 'translate(0, 0) scale(0) rotate(0deg)';
          el.offsetHeight; // force reflow

          // stagger the burst outward
          var delay = i * 30 + Math.random() * 20;
          var tid1 = setTimeout(function () {
            el.style.transition = 'transform 0.5s cubic-bezier(0.22, 1.2, 0.36, 1), opacity 0.3s ease';
            el.style.transform = 'translate(' + x + 'px, ' + y + 'px) scale(' + scale + ') rotate(' + rot + 'deg)';
          }, delay);
          timeout_ids.push(tid1);

          // fade out after landing
          var tid2 = setTimeout(function () {
            el.style.transition = 'opacity 0.6s ease';
            el.style.opacity = '0';
          }, delay + 600);
          timeout_ids.push(tid2);
        });
      });

      card.addEventListener('mouseleave', function () {
        timeout_ids.forEach(clearTimeout);
        timeout_ids = [];
        flung.forEach(function (el) {
          el.style.transition = 'transform 0.25s ease-in, opacity 0.2s ease';
          el.style.transform = 'translate(0, 0) scale(0) rotate(0deg)';
          el.style.opacity = '0';
        });
      });
    });
  });
  </script>
</body>
</html>
